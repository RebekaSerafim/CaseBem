{% extends "fornecedor/base.html" %}

{% block title %}
{% if orcamento and orcamento.id %}Editar Orçamento{% else %}Novo Orçamento{% endif %}
{% endblock %}

{% block conteudo %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                {% if orcamento and orcamento.id %}
                    Editar Orçamento
                {% else %}
                    Novo Orçamento
                {% endif %}
            </h1>
            <a href="/fornecedor/orcamentos" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>
</div>

<!-- Informações da Demanda -->
{% if demanda %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Informações da Demanda</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5>{{ demanda.titulo }}</h5>
                        <p class="text-muted">{{ demanda.descricao }}</p>
                    </div>
                    <div class="col-md-4">
                        {% if demanda.orcamento_min and demanda.orcamento_max %}
                        <div class="alert alert-info mb-2">
                            <small>
                                <strong>Faixa de Orçamento:</strong><br>
                                R$ {{ "%.2f"|format(demanda.orcamento_min) }} - R$ {{ "%.2f"|format(demanda.orcamento_max) }}
                            </small>
                        </div>
                        {% endif %}
                        {% if demanda.prazo_entrega %}
                        <div class="alert alert-warning mb-0">
                            <small>
                                <strong>Prazo Solicitado:</strong><br>
                                {{ demanda.prazo_entrega }}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Formulário do Orçamento -->
<div class="row">
    <div class="col-12">
        <form method="post" id="formOrcamento">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Dados do Orçamento</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="prazo_entrega" class="form-label">Prazo de Entrega</label>
                            <input type="date" class="form-control" id="prazo_entrega" name="prazo_entrega"
                                   value="{{ orcamento.prazo_entrega if orcamento else '' }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="desconto" class="form-label">Desconto (%)</label>
                            <input type="number" class="form-control" id="desconto" name="desconto"
                                   value="{{ orcamento.desconto if orcamento else '0' }}"
                                   min="0" max="100" step="0.01">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3"
                                  placeholder="Informações adicionais sobre o orçamento...">{{ orcamento.observacoes if orcamento else '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Seleção de Itens -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Itens do Orçamento</h6>
                    <button type="button" class="btn btn-sm btn-success" onclick="adicionarItem()">
                        <i class="fas fa-plus"></i> Adicionar Item
                    </button>
                </div>
                <div class="card-body">
                    <div id="itens-container">
                        {% if orcamento and orcamento.itens %}
                            {% for item_orcamento in orcamento.itens %}
                            <div class="item-row border rounded p-3 mb-3">
                                <div class="row align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label">Item</label>
                                        <select class="form-select item-select" name="item_id[]" required>
                                            <option value="">Selecione um item</option>
                                            {% for item in meus_itens %}
                                            <option value="{{ item.id }}"
                                                    data-preco="{{ item.preco }}"
                                                    {% if item.id == item_orcamento.id_item %}selected{% endif %}>
                                                {{ item.nome }} - R$ {{ "%.2f"|format(item.preco) }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Quantidade</label>
                                        <input type="number" class="form-control quantidade-input"
                                               name="quantidade[]" value="{{ item_orcamento.quantidade }}"
                                               min="1" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Preço Unit.</label>
                                        <input type="number" class="form-control preco-input"
                                               name="preco_unitario[]" value="{{ item_orcamento.preco_unitario }}"
                                               step="0.01" min="0" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Desconto Item</label>
                                        <input type="number" class="form-control desconto-item-input"
                                               name="desconto_item[]" value="{{ item_orcamento.desconto or 0 }}"
                                               step="0.01" min="0">
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label">Total</label>
                                        <div class="fw-bold total-item">R$ 0,00</div>
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerItem(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <label class="form-label">Observações do Item</label>
                                        <input type="text" class="form-control" name="observacoes_item[]"
                                               value="{{ item_orcamento.observacoes or '' }}"
                                               placeholder="Observações específicas deste item...">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <!-- Item vazio inicial -->
                        <div class="item-row border rounded p-3 mb-3">
                            <div class="row align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label">Item</label>
                                    <select class="form-select item-select" name="item_id[]" required>
                                        <option value="">Selecione um item</option>
                                        {% for item in meus_itens %}
                                        <option value="{{ item.id }}" data-preco="{{ item.preco }}">
                                            {{ item.nome }} - R$ {{ "%.2f"|format(item.preco) }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Quantidade</label>
                                    <input type="number" class="form-control quantidade-input"
                                           name="quantidade[]" value="1" min="1" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Preço Unit.</label>
                                    <input type="number" class="form-control preco-input"
                                           name="preco_unitario[]" value="0" step="0.01" min="0" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Desconto Item</label>
                                    <input type="number" class="form-control desconto-item-input"
                                           name="desconto_item[]" value="0" step="0.01" min="0">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">Total</label>
                                    <div class="fw-bold total-item">R$ 0,00</div>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerItem(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <label class="form-label">Observações do Item</label>
                                    <input type="text" class="form-control" name="observacoes_item[]"
                                           placeholder="Observações específicas deste item...">
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Total Geral -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h5>Total do Orçamento</h5>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <h4 class="text-success" id="valor-total-geral">R$ 0,00</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botões -->
            <div class="card mt-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <a href="/fornecedor/orcamentos" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i>
                            {% if orcamento and orcamento.id %}
                                Atualizar Orçamento
                            {% else %}
                                Enviar Orçamento
                            {% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function adicionarItem() {
    const container = document.getElementById('itens-container');
    const itemTemplate = `
        <div class="item-row border rounded p-3 mb-3">
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Item</label>
                    <select class="form-select item-select" name="item_id[]" required>
                        <option value="">Selecione um item</option>
                        {% for item in meus_itens %}
                        <option value="{{ item.id }}" data-preco="{{ item.preco }}">
                            {{ item.nome }} - R$ {{ "%.2f"|format(item.preco) }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Quantidade</label>
                    <input type="number" class="form-control quantidade-input"
                           name="quantidade[]" value="1" min="1" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Preço Unit.</label>
                    <input type="number" class="form-control preco-input"
                           name="preco_unitario[]" value="0" step="0.01" min="0" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Desconto Item</label>
                    <input type="number" class="form-control desconto-item-input"
                           name="desconto_item[]" value="0" step="0.01" min="0">
                </div>
                <div class="col-md-1">
                    <label class="form-label">Total</label>
                    <div class="fw-bold total-item">R$ 0,00</div>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerItem(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <label class="form-label">Observações do Item</label>
                    <input type="text" class="form-control" name="observacoes_item[]"
                           placeholder="Observações específicas deste item...">
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', itemTemplate);
    setupItemEventListeners();
}

function removerItem(button) {
    const itemRow = button.closest('.item-row');
    itemRow.remove();
    calcularTotalGeral();
}

function setupItemEventListeners() {
    // Configurar eventos para todos os itens
    document.querySelectorAll('.item-select').forEach(select => {
        select.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const preco = selectedOption.dataset.preco || 0;
            const row = this.closest('.item-row');
            const precoInput = row.querySelector('.preco-input');
            precoInput.value = preco;
            calcularTotalItem(row);
        });
    });

    document.querySelectorAll('.quantidade-input, .preco-input, .desconto-item-input').forEach(input => {
        input.addEventListener('input', function() {
            const row = this.closest('.item-row');
            calcularTotalItem(row);
        });
    });
}

function calcularTotalItem(row) {
    const quantidade = parseFloat(row.querySelector('.quantidade-input').value) || 0;
    const precoUnitario = parseFloat(row.querySelector('.preco-input').value) || 0;
    const desconto = parseFloat(row.querySelector('.desconto-item-input').value) || 0;

    const total = (quantidade * precoUnitario) - desconto;
    row.querySelector('.total-item').textContent = 'R$ ' + total.toFixed(2);

    calcularTotalGeral();
}

function calcularTotalGeral() {
    let totalGeral = 0;
    document.querySelectorAll('.total-item').forEach(totalDiv => {
        const valor = parseFloat(totalDiv.textContent.replace('R$ ', '').replace(',', '.')) || 0;
        totalGeral += valor;
    });

    // Aplicar desconto geral
    const descontoGeral = parseFloat(document.getElementById('desconto').value) || 0;
    const totalComDesconto = totalGeral * (1 - descontoGeral / 100);

    document.getElementById('valor-total-geral').textContent = 'R$ ' + totalComDesconto.toFixed(2);
}

// Configurar eventos no carregamento da página
document.addEventListener('DOMContentLoaded', function() {
    setupItemEventListeners();
    calcularTotalGeral();

    // Configurar evento para desconto geral
    document.getElementById('desconto').addEventListener('input', calcularTotalGeral);
});
</script>
{% endblock %}