{% extends "admin/base.html" %}

{% block title %}Detalhes do Usuário{% endblock %}

{% block conteudo %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Detalhes do Usuário</h1>
            <a href="/admin/usuarios" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>
</div>

{% if usuario %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Informações Básicas</h5>
            </div>
            <div class="card-body pb-1">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">ID:</dt>
                            <dd class="col-sm-8">{{ usuario.id }}</dd>

                            <dt class="col-sm-4">Nome:</dt>
                            <dd class="col-sm-8">{{ usuario.nome }}</dd>

                            <dt class="col-sm-4">Email:</dt>
                            <dd class="col-sm-8">{{ usuario.email }}</dd>

                            <dt class="col-sm-4">Telefone:</dt>
                            <dd class="col-sm-8 phone-format">{{ usuario.telefone or '-' }}</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Tipo:</dt>
                            <dd class="col-sm-8">
                                <span class="badge
                                    {% if usuario.perfil.value == 'ADMIN' %}bg-danger
                                    {% elif usuario.perfil.value == 'FORNECEDOR' %}bg-primary
                                    {% else %}bg-success{% endif %}">
                                    {% if usuario.perfil.value == 'ADMIN' %}Administrador
                                    {% elif usuario.perfil.value == 'FORNECEDOR' %}Fornecedor
                                    {% else %}Noivo{% endif %}
                                </span>
                            </dd>

                            <dt class="col-sm-4">Cadastro:</dt>
                            <dd class="col-sm-8">{{ usuario.data_cadastro | formatar_data }}</dd>

                            <dt class="col-sm-4">Status:</dt>
                            <dd class="col-sm-8">
                                <span class="badge {{ 'bg-success' if usuario.ativo else 'bg-danger' }}">
                                    {{ "Ativo" if usuario.ativo else "Bloqueado" }}
                                </span>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        {% if fornecedor %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Informações do Fornecedor</h5>
            </div>
            <div class="card-body pb-1">
                <dl class="row mb-0">
                    <dt class="col-sm-3">CNPJ:</dt>
                    <dd class="col-sm-9 cnpj-format">{{ fornecedor.cnpj or '-' }}</dd>

                    <dt class="col-sm-3">Verificado:</dt>
                    <dd class="col-sm-9">
                        <span class="badge {{ 'bg-success' if fornecedor.verificado else 'bg-warning' }}">
                            {{ "Sim" if fornecedor.verificado else "Não" }}
                        </span>
                    </dd>
                    {% if fornecedor.descricao %}
                    <dt class="col-sm-3">Descrição:</dt>
                    <dd class="col-sm-9">{{ fornecedor.descricao }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Ações</h5>
            </div>
            <div class="card-body">
                {% if usuario.perfil.value == 'FORNECEDOR' and fornecedor %}
                {% if not fornecedor.verificado %}
                <form method="post" action="/admin/verificacao/{{ fornecedor.id }}/aprovar" class="mb-2">
                    <button type="submit" class="btn btn-success w-100" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Aprovar fornecedor para o sistema">
                        <i class="bi bi-check-circle-fill"></i> Aprovar Fornecedor
                    </button>
                </form>

                <button type="button" class="btn btn-warning w-100 mb-2" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Rejeitar cadastro do fornecedor" onclick="mostrarFormRejeicao()">
                    <i class="bi bi-x-circle-fill"></i> Rejeitar Fornecedor
                </button>

                <div id="formRejeicao" style="display: none;" class="mt-3">
                    <form method="post" action="/admin/verificacao/{{ fornecedor.id }}/rejeitar">
                        <div class="mb-3">
                            <label for="observacoes" class="form-label">Motivo da rejeição:</label>
                            <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-warning w-100">
                            <i class="bi bi-x-circle-fill"></i> Confirmar Rejeição
                        </button>
                        <button type="button" class="btn btn-secondary w-100 mt-2" onclick="esconderFormRejeicao()">
                            Cancelar
                        </button>
                    </form>
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill"></i> Fornecedor já verificado
                </div>
                {% endif %}
                {% endif %}

                {% if usuario.ativo %}
                <button type="button" class="btn btn-warning w-100" data-bs-toggle="tooltip" data-bs-placement="top"
                    title="Bloquear acesso do usuário ao sistema"
                    onclick="confirmarBloqueio({{ usuario.id }}, '{{ usuario.nome }}')">
                    <i class="bi bi-lock-fill"></i> Bloquear Usuário
                </button>
                {% else %}
                <form method="post" action="/admin/usuarios/{{ usuario.id }}/ativar">
                    <button type="submit" class="btn btn-success w-100" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Reativar acesso do usuário ao sistema">
                        <i class="bi bi-unlock-fill"></i> Ativar Usuário
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

    </div>
</div>

{% else %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body text-center py-5">
                <i class="bi bi-person-x" style="font-size: 4rem; color: #6c757d;" class="mb-4"></i>
                <h4>Usuário não encontrado</h4>
                <p class="text-muted">O usuário solicitado não existe ou foi removido do sistema.</p>
                <a href="/admin/usuarios" class="btn btn-primary">
                    <i class="bi bi-arrow-left"></i> Voltar para Usuários
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // Inicializar tooltips
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });

    function confirmarBloqueio(id, nome) {
        mostrarModalConfirmacao({
            titulo: 'Confirmar Bloqueio',
            texto: `Tem certeza que deseja bloquear o usuário ${nome}?`,
            subtexto: 'O usuário não poderá mais acessar o sistema.',
            tipo: 'warning',
            textoBotao: 'Bloquear',
            onConfirmar: function() {
                // Criar form dinamicamente e submeter
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/admin/usuarios/${id}/bloquear`;
                document.body.appendChild(form);
                form.submit();
            }
        });
    }

    function mostrarFormRejeicao() {
        document.getElementById('formRejeicao').style.display = 'block';
    }

    function esconderFormRejeicao() {
        document.getElementById('formRejeicao').style.display = 'none';
    }
</script>
{% endblock %}